"use strict";function Player(e){this.stream=e.stream,this.appid=e.appid,this.deviceid=e.deviceid}var INIT="init",START="start",PAUSE="pause",DESTORY="destory",DISCONNECT="disconnect",CURRENTTIME="currentTime",SHOTIMAGE="shotImage",BSERURL="http://33.95.241.120:8008";Player.prototype={constructor:Player,init:function(){var e=document.getElementById("player");flvjs.isSupported()&&(this.pInstance&&this.destory(),this.pInstance=flvjs.createPlayer({type:"flv",url:this.stream,hasVideo:!0,hasAudio:!1,isLive:!0,cors:!0},{enableWorker:!0,enableStashBuffer:!1,stashInitialSize:120,autoCleanupSourceBuffer:!0,autoCleanupMaxBackwardDuration:5,autoCleanupMinBackwardDuration:3,lazyLoadMaxDuration:180,seekType:"range"}),this.pInstance.attachMediaElement(e),this.load(),this.start())},load:function(){this.pInstance.load()},start:function(){this.pInstance.play()},pause:function(){this.pInstance.pause()},reconnect:function(){var e=this,t=0,a=setInterval(function(){console.log(++t+"times reconnect...");var n=new XMLHttpRequest,s=JSON.stringify({appId:e.appid,deviceId:e.deviceid,type:"flv"});n.open("POST",BSERURL+"/v1/gb/stream/start",!0),n.setRequestHeader("Content-Type","application/json;charset=utf-8"),n.onreadystatechange=function(){if(4==n.readyState&&200==n.status){clearInterval(a);var s=JSON.parse(n.response);e.stream=s.data[0].playUrl,e.init()}t>100&&a&&clearInterval(a)},n.send(s)},2e3)},destory:function(){this.pInstance.pause(),this.pInstance.unload(),this.pInstance.detachMediaElement(),this.pInstance.destroy(),this.pInstance=null},getCurrentTime:function(){window.parent.postMessage({action:"currentTime",result:{time:document.getElementById("player").currentTime}},"*")},screenshot:function(){var e=document.createElement("canvas"),t=document.getElementById("player");e.width=t.videoWidth,e.height=t.videoHeight,e.getContext("2d").drawImage(t,0,0,t.videoWidth,t.videoHeight);var a=e.toDataURL("image/png");window.parent.postMessage({action:"shotImage",result:{imageBase64:a}},"*")}};var Util={checkStream:function(e){var t=e.lastIndexOf(".");return"flv"===e.substring(t+1)||(alert("格式不支持"),!1)},base64ToBlob:function(e){for(var t=e.split(";base64,"),a=t[0].split(":")[1],n=window.atob(t[1]),s=n.length,i=new Uint8Array(s),r=0;r<s;++r)i[r]=n.charCodeAt(r);return new Blob([i],{type:a})}},searchs=window.location.search;if(searchs){searchs=searchs.substring(1).split("&");var config=new Object;if(searchs.forEach(function(e){var t=e.split("=");config[t[0].toLowerCase()]=t[1]}),config.stream){var szPlayer=new Player(config);szPlayer.init()}else alert("没有流地址")}window.addEventListener("message",function(e){switch(e.data.action){case INIT:szPlayer.init();break;case START:szPlayer.start();break;case PAUSE:szPlayer.pause();break;case DESTORY:szPlayer.destory();break;case DISCONNECT:szPlayer.reconnect();break;case CURRENTTIME:szPlayer.getCurrentTime();break;case SHOTIMAGE:szPlayer.screenshot()}},!1),document.addEventListener("visibilitychange",function(){"visible"==document.visibilityState&&szPlayer.init()});